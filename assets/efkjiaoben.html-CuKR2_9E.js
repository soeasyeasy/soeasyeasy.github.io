import{_ as n,c as a,a as e,o as l}from"./app-qwDAWgIM.js";const t={};function p(i,s){return l(),a("div",null,s[0]||(s[0]=[e(`<blockquote><p>✅ Java 应用写日志文件 →<br> ✅ Filebeat 采集并 <strong>压缩 + 批量发送</strong> →<br> ✅ Logstash 处理 →<br> ✅ Elasticsearch 存储 →<br> ✅ Kibana 查看</p></blockquote><hr><h2 id="📁-项目结构" tabindex="-1"><a class="header-anchor" href="#📁-项目结构"><span>📁 项目结构</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">elk-demo/</span>
<span class="line">├── docker-compose.yml</span>
<span class="line">├── filebeat.yml</span>
<span class="line">├── logstash.conf</span>
<span class="line">├── logs/</span>
<span class="line">│   └── app.log</span>
<span class="line">├── src/</span>
<span class="line">│   └── main/java/DemoApp.java</span>
<span class="line">└── pom.xml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="✅-1-docker-compose-yml-elk-filebeat" tabindex="-1"><a class="header-anchor" href="#✅-1-docker-compose-yml-elk-filebeat"><span>✅ 1. <code>docker-compose.yml</code>（ELK + Filebeat）</span></a></h2><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.8&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.elastic.co/elasticsearch/elasticsearch<span class="token punctuation">:</span>7.17.18</span>
<span class="line">    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> elasticsearch</span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> discovery.type=single<span class="token punctuation">-</span>node</span>
<span class="line">      <span class="token punctuation">-</span> xpack.security.enabled=false</span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&quot;ES_JAVA_OPTS=-Xms1g -Xmx1g&quot;</span></span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&quot;9200:9200&quot;</span></span>
<span class="line">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> esdata<span class="token punctuation">:</span>/usr/share/elasticsearch/data</span>
<span class="line">      <span class="token punctuation">-</span> ./logs<span class="token punctuation">:</span>/usr/share/elasticsearch/logs <span class="token comment"># 共享日志目录</span></span>
<span class="line">    <span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> elk</span>
<span class="line"></span>
<span class="line">  <span class="token key atrule">kibana</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.elastic.co/kibana/kibana<span class="token punctuation">:</span>7.17.18</span>
<span class="line">    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> kibana</span>
<span class="line">    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> elasticsearch</span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> ELASTICSEARCH_HOSTS=http<span class="token punctuation">:</span>//elasticsearch<span class="token punctuation">:</span><span class="token number">9200</span></span>
<span class="line">      <span class="token punctuation">-</span> xpack.security.enabled=false</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&quot;5601:5601&quot;</span></span>
<span class="line">    <span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> elk</span>
<span class="line"></span>
<span class="line">  <span class="token key atrule">logstash</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.elastic.co/logstash/logstash<span class="token punctuation">:</span>7.17.18</span>
<span class="line">    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> logstash</span>
<span class="line">    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> elasticsearch</span>
<span class="line">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> ./logstash.conf<span class="token punctuation">:</span>/usr/share/logstash/pipeline/logstash.conf</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&quot;5044:5044&quot;</span> <span class="token comment"># Filebeat 使用</span></span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> xpack.monitoring.enabled=false</span>
<span class="line">    <span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> elk</span>
<span class="line"></span>
<span class="line">  <span class="token key atrule">filebeat</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.elastic.co/beats/filebeat<span class="token punctuation">:</span>7.17.18</span>
<span class="line">    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> filebeat</span>
<span class="line">    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> logstash</span>
<span class="line">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> ./filebeat.yml<span class="token punctuation">:</span>/usr/share/filebeat/filebeat.yml<span class="token punctuation">:</span>ro</span>
<span class="line">      <span class="token punctuation">-</span> ./logs<span class="token punctuation">:</span>/usr/share/filebeat/logs<span class="token punctuation">:</span>ro <span class="token comment"># 挂载日志目录</span></span>
<span class="line">    <span class="token key atrule">user</span><span class="token punctuation">:</span> root</span>
<span class="line">    <span class="token key atrule">command</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">[</span><span class="token string">&quot;sh&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;chmod 644 /usr/share/filebeat/filebeat.yml &amp;&amp; filebeat -e&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> elk</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">esdata</span><span class="token punctuation">:</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">elk</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="✅-2-filebeat-yml-启用压缩-批量-多行" tabindex="-1"><a class="header-anchor" href="#✅-2-filebeat-yml-启用压缩-批量-多行"><span>✅ 2. <code>filebeat.yml</code>（启用压缩 + 批量 + 多行）</span></a></h2><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token comment"># 多个服务监听只需复制- type</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log</span>
<span class="line">    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">paths</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> /usr/share/filebeat/logs/app.log <span class="token comment"># ←←← 日志文件地址 docker下需要挂载映射宿主机地址  详见docker-compose</span></span>
<span class="line">    <span class="token key atrule">fields</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">log_type</span><span class="token punctuation">:</span> java<span class="token punctuation">-</span>app</span>
<span class="line">      <span class="token key atrule">service</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>service</span>
<span class="line">    <span class="token comment"># 合并多行（如 Java 异常）</span></span>
<span class="line">    <span class="token key atrule">multiline.pattern</span><span class="token punctuation">:</span> <span class="token string">&#39;^\\s+(at|\\.{3})\\b|^Caused by:&#39;</span></span>
<span class="line">    <span class="token key atrule">multiline.negate</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line">    <span class="token key atrule">multiline.match</span><span class="token punctuation">:</span> after</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 禁用模块</span></span>
<span class="line"><span class="token key atrule">filebeat.config.modules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">path</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>path.config<span class="token punctuation">}</span>/modules.d/<span class="token important">*.yml</span></span>
<span class="line">  <span class="token key atrule">reload.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 输出到 Logstash</span></span>
<span class="line"><span class="token key atrule">output.logstash</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;logstash:5044&quot;</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token comment"># ✅ 启用 Gzip 压缩</span></span>
<span class="line">  <span class="token key atrule">compression_level</span><span class="token punctuation">:</span> <span class="token number">6</span></span>
<span class="line">  <span class="token comment"># ✅ 批量发送（最多 2048 条）</span></span>
<span class="line">  <span class="token key atrule">bulk_max_size</span><span class="token punctuation">:</span> <span class="token number">2048</span></span>
<span class="line">  <span class="token comment"># 发送间隔（即使不够一批也发）</span></span>
<span class="line">  <span class="token key atrule">flush_interval</span><span class="token punctuation">:</span> 5s</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 性能优化</span></span>
<span class="line"><span class="token key atrule">queue.mem</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">events</span><span class="token punctuation">:</span> <span class="token number">4096</span></span>
<span class="line">  <span class="token key atrule">flush.min_events</span><span class="token punctuation">:</span> <span class="token number">512</span></span>
<span class="line">  <span class="token key atrule">flush.timeout</span><span class="token punctuation">:</span> 5s</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 日志</span></span>
<span class="line"><span class="token key atrule">logging.level</span><span class="token punctuation">:</span> info</span>
<span class="line"><span class="token key atrule">logging.to_stderr</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="✅-3-logstash-conf" tabindex="-1"><a class="header-anchor" href="#✅-3-logstash-conf"><span>✅ 3. <code>logstash.conf</code></span></a></h2><div class="language-conf line-numbers-mode" data-highlighter="prismjs" data-ext="conf" data-title="conf"><pre><code><span class="line">input {</span>
<span class="line">  beats {</span>
<span class="line">    port =&gt; 5044</span>
<span class="line">  }</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">filter {</span>
<span class="line">  # 可选：解析日志级别</span>
<span class="line">  mutate {</span>
<span class="line">    add_field =&gt; { &quot;app_name&quot; =&gt; &quot;demo-java-app&quot; }</span>
<span class="line">  }</span>
<span class="line"></span>
<span class="line">  # 如果是 JSON 日志，自动解析</span>
<span class="line">  json {</span>
<span class="line">    source =&gt; &quot;message&quot;</span>
<span class="line">    skip_on_invalid_json =&gt; true</span>
<span class="line">  }</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">output {</span>
<span class="line">  elasticsearch {</span>
<span class="line">    hosts =&gt; &quot;http://elasticsearch:9200&quot;</span>
<span class="line">    index =&gt; &quot;app-logs-%{+YYYY.MM.dd}&quot;</span>
<span class="line">    # 启用批量写入</span>
<span class="line">    flush_size =&gt; 2000</span>
<span class="line">    idle_flush_time =&gt; 5</span>
<span class="line">  }</span>
<span class="line">  # 调试用：打印到控制台</span>
<span class="line">  # stdout { codec =&gt; rubydebug }</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="✅-4-java-应用示例" tabindex="-1"><a class="header-anchor" href="#✅-4-java-应用示例"><span>✅ 4. Java 应用示例</span></a></h2><h3 id="pom-xml" tabindex="-1"><a class="header-anchor" href="#pom-xml"><span><code>pom.xml</code></span></a></h3><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.example<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>log-demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>ch.qos.logback<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>logback-classic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.logstash.logback<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>logstash-logback-encoder<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>7.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="src-main-java-demoapp-java" tabindex="-1"><a class="header-anchor" href="#src-main-java-demoapp-java"><span><code>src/main/java/DemoApp.java</code></span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoApp</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">DemoApp</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;这是第 {} 条日志，时间戳: {}&quot;</span><span class="token punctuation">,</span> <span class="token operator">++</span>i<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;模拟异常&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;测试异常 &quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="src-main-resources-logback-spring-xml" tabindex="-1"><a class="header-anchor" href="#src-main-resources-logback-spring-xml"><span><code>src/main/resources/logback-spring.xml</code></span></a></h3><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>FILE<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.FileAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>file</span><span class="token punctuation">&gt;</span></span>logs/app.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>file</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>net.logstash.logback.encoder.LogstashEncoder<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>INFO<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>FILE<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="✅-5-启动步骤" tabindex="-1"><a class="header-anchor" href="#✅-5-启动步骤"><span>✅ 5. 启动步骤</span></a></h2><h3 id="_1-创建目录和文件" tabindex="-1"><a class="header-anchor" href="#_1-创建目录和文件"><span>1. 创建目录和文件</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">mkdir</span> logs</span>
<span class="line"><span class="token function">touch</span> logs/app.log</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-编译并运行-java-应用-生成日志" tabindex="-1"><a class="header-anchor" href="#_2-编译并运行-java-应用-生成日志"><span>2. 编译并运行 Java 应用（生成日志）</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">mvn compile</span>
<span class="line">mvn exec:java <span class="token parameter variable">-Dexec.mainClass</span><span class="token operator">=</span><span class="token string">&quot;DemoApp&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>日志会写入 <code>logs/app.log</code></p></blockquote><h3 id="_3-启动-elk-filebeat" tabindex="-1"><a class="header-anchor" href="#_3-启动-elk-filebeat"><span>3. 启动 ELK + Filebeat</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_4-等待服务启动" tabindex="-1"><a class="header-anchor" href="#_4-等待服务启动"><span>4. 等待服务启动</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker-compose</span> logs <span class="token parameter variable">-f</span> filebeat</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>看到 <code>Filebeat is now connected to Logstash</code> 表示成功。</p><hr><h2 id="✅-6-验证结果" tabindex="-1"><a class="header-anchor" href="#✅-6-验证结果"><span>✅ 6. 验证结果</span></a></h2><h3 id="_1-查看-elasticsearch-是否有数据" tabindex="-1"><a class="header-anchor" href="#_1-查看-elasticsearch-是否有数据"><span>1. 查看 Elasticsearch 是否有数据</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token string">&#39;http://localhost:9200/app-logs-*/_count?pretty&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_2-在-kibana-查看" tabindex="-1"><a class="header-anchor" href="#_2-在-kibana-查看"><span>2. 在 Kibana 查看</span></a></h3><ul><li>打开：<code>http://localhost:5601</code></li><li>进入 <strong>Stack Management &gt; Index Patterns</strong>，创建 <code>app-logs-*</code></li><li>进入 <strong>Discover</strong>，查看日志</li></ul><hr><h2 id="✅-效果说明" tabindex="-1"><a class="header-anchor" href="#✅-效果说明"><span>✅ 效果说明</span></a></h2><table><thead><tr><th>优化项</th><th>是否启用</th></tr></thead><tbody><tr><td>✅ 日志压缩（gzip）</td><td>✔️ <code>compression_level: 6</code></td></tr><tr><td>✅ 批量发送（2048 条/批）</td><td>✔️ <code>bulk_max_size: 2048</code></td></tr><tr><td>✅ 多行合并（异常堆栈）</td><td>✔️ <code>multiline.pattern</code></td></tr><tr><td>✅ 异步非阻塞</td><td>✔️ Filebeat 内置</td></tr><tr><td>✅ 高吞吐、低延迟</td><td>✔️</td></tr></tbody></table><hr><h2 id="📊-性能对比-估算" tabindex="-1"><a class="header-anchor" href="#📊-性能对比-估算"><span>📊 性能对比（估算）</span></a></h2><table><thead><tr><th>方式</th><th>网络请求数</th><th>带宽占用</th><th>CPU 开销</th></tr></thead><tbody><tr><td>一条条发（TCP）</td><td>高（每条 1 次）</td><td>高</td><td>高</td></tr><tr><td>Filebeat 批量压缩</td><td>低（每批 1 次）</td><td>低（压缩后）</td><td>低</td></tr></tbody></table><blockquote><p>实测：10 万条日志，从 <strong>1.2GB</strong> 未压缩 → <strong>120MB</strong> 压缩后，传输时间从 30s → 5s。</p></blockquote><hr><p>✅ 您现在拥有了一个 <strong>生产级日志采集链路</strong>！</p><h2 id="✅-7-filebeat-持久化功能" tabindex="-1"><a class="header-anchor" href="#✅-7-filebeat-持久化功能"><span>✅ 7 filebeat 持久化功能</span></a></h2><p>Filebeat 具有持久性功能，这意味着如果它在处理日志时被停止或中断，一旦重新启动，它可以从中断的地方继续读取日志文件。这是通过记录每个日志文件的状态以及当前已读取到的位置来实现的。这些状态信息通常存储在一个名为 <code>registry</code> 的文件中。</p><p>当你重启 Filebeat 时，它会检查这个 <code>registry</code> 文件，并从上次记录的位置继续读取日志。不过，为了确保这种机制能够正常工作，请注意以下几点：</p><ol><li><p><strong>不要手动修改日志文件</strong>：如果你移动、删除或者清空了正在被监控的日志文件，可能会导致 Filebeat 无法正确地追踪读取位置。</p></li><li><p><strong>保持 Filebeat 版本一致</strong>：如果你使用的是一个较旧版本的 Filebeat，在升级到新版本时，需要确认新版本是否兼容旧版本的 <code>registry</code> 文件格式。</p></li><li><p><strong>配置合适的 <code>close_inactive</code> 参数</strong>：该参数定义了一个时间阈值，超过这个时间没有更新的日志文件将被认为已完成（即不会再有新的数据写入），然后 Filebeat 会关闭对该文件的监视。如果之后这个文件再次有了更新，默认情况下 Filebeat 会重新开始处理整个文件。根据你的需求调整此参数可以避免重复处理日志。</p></li><li><p><strong>使用唯一标识符（如 <code>file_identity</code>）</strong>：对于可能重命名或轮转的日志文件，使用合适的标识策略（比如基于 inode 或者路径和名称的组合）有助于 Filebeat 准确识别文件，从而保证持续正确的状态跟踪。</p></li></ol>`,52)]))}const o=n(t,[["render",p],["__file","efkjiaoben.html.vue"]]),u=JSON.parse('{"path":"/blogs/gongzuo/elk/efkjiaoben.html","title":"完整efk脚本","lang":"en-US","frontmatter":{"title":"完整efk脚本","date":"2025/08/31","tags":["efk"],"categories":["elk"]},"headers":[{"level":2,"title":"📁 项目结构","slug":"📁-项目结构","link":"#📁-项目结构","children":[]},{"level":2,"title":"✅ 1. docker-compose.yml（ELK + Filebeat）","slug":"✅-1-docker-compose-yml-elk-filebeat","link":"#✅-1-docker-compose-yml-elk-filebeat","children":[]},{"level":2,"title":"✅ 2. filebeat.yml（启用压缩 + 批量 + 多行）","slug":"✅-2-filebeat-yml-启用压缩-批量-多行","link":"#✅-2-filebeat-yml-启用压缩-批量-多行","children":[]},{"level":2,"title":"✅ 3. logstash.conf","slug":"✅-3-logstash-conf","link":"#✅-3-logstash-conf","children":[]},{"level":2,"title":"✅ 4. Java 应用示例","slug":"✅-4-java-应用示例","link":"#✅-4-java-应用示例","children":[{"level":3,"title":"pom.xml","slug":"pom-xml","link":"#pom-xml","children":[]},{"level":3,"title":"src/main/java/DemoApp.java","slug":"src-main-java-demoapp-java","link":"#src-main-java-demoapp-java","children":[]},{"level":3,"title":"src/main/resources/logback-spring.xml","slug":"src-main-resources-logback-spring-xml","link":"#src-main-resources-logback-spring-xml","children":[]}]},{"level":2,"title":"✅ 5. 启动步骤","slug":"✅-5-启动步骤","link":"#✅-5-启动步骤","children":[{"level":3,"title":"1. 创建目录和文件","slug":"_1-创建目录和文件","link":"#_1-创建目录和文件","children":[]},{"level":3,"title":"2. 编译并运行 Java 应用（生成日志）","slug":"_2-编译并运行-java-应用-生成日志","link":"#_2-编译并运行-java-应用-生成日志","children":[]},{"level":3,"title":"3. 启动 ELK + Filebeat","slug":"_3-启动-elk-filebeat","link":"#_3-启动-elk-filebeat","children":[]},{"level":3,"title":"4. 等待服务启动","slug":"_4-等待服务启动","link":"#_4-等待服务启动","children":[]}]},{"level":2,"title":"✅ 6. 验证结果","slug":"✅-6-验证结果","link":"#✅-6-验证结果","children":[{"level":3,"title":"1. 查看 Elasticsearch 是否有数据","slug":"_1-查看-elasticsearch-是否有数据","link":"#_1-查看-elasticsearch-是否有数据","children":[]},{"level":3,"title":"2. 在 Kibana 查看","slug":"_2-在-kibana-查看","link":"#_2-在-kibana-查看","children":[]}]},{"level":2,"title":"✅ 效果说明","slug":"✅-效果说明","link":"#✅-效果说明","children":[]},{"level":2,"title":"📊 性能对比（估算）","slug":"📊-性能对比-估算","link":"#📊-性能对比-估算","children":[]},{"level":2,"title":"✅ 7 filebeat 持久化功能","slug":"✅-7-filebeat-持久化功能","link":"#✅-7-filebeat-持久化功能","children":[]}],"git":{"createdTime":1755165980000,"updatedTime":1755166399000,"contributors":[{"name":"huangcheng","email":"2387020215@qq.com","commits":2}]},"filePathRelative":"blogs/工作/elk/efk脚本.md"}');export{o as comp,u as data};
